{"id":1269,"date":"2021-08-21T11:20:40","date_gmt":"2021-08-21T15:20:40","guid":{"rendered":"https:\/\/learn.codethedream.org\/?page_id=1269"},"modified":"2022-02-03T10:37:36","modified_gmt":"2022-02-03T15:37:36","slug":"rest-introduction-and-authentication","status":"publish","type":"page","link":"https:\/\/learn.codethedream.org\/rest-introduction-and-authentication\/","title":{"rendered":"REST Introduction and Authentication"},"content":{"rendered":"\n<p>We are going to create an API that communicates using REST protocols, and that exchanges JSON data.  It&#8217;s a good idea to understand what REST is:<\/p>\n\n\n\n<p><a href=\"https:\/\/dzone.com\/articles\/introduction-to-rest-api-restful-web-services\">https:\/\/dzone.com\/articles\/introduction-to-rest-api-restful-web-services<\/a><\/p>\n\n\n\n<p>And also, you will want to understand JSON:<\/p>\n\n\n\n<figure class=\"wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio\"><div class=\"wp-block-embed__wrapper\">\n<iframe loading=\"lazy\" title=\"Learn JSON - Full Crash Course for Beginners\" width=\"500\" height=\"281\" src=\"https:\/\/www.youtube.com\/embed\/GpOO5iKzOmY?feature=oembed\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen><\/iframe>\n<\/div><\/figure>\n\n\n\n<h2>Creating the API Server Application<\/h2>\n\n\n\n<p>A starter Rails application for the API Server has been created for you in the git repository  <strong><a rel=\"noreferrer noopener\" href=\"https:\/\/github.com\/Code-the-Dream-School\/R6-rest-rails\" target=\"_blank\">here.<\/a><\/strong>  You do NOT need to do the command to create the application.  You only need to fork and clone the repository as usual.  After you have cloned the repository, cd to the repository directory and create a branch called rest-authentication.  This is where you will put the first part of your assignment. <\/p>\n\n\n\n<p>The command we used to create this workspace was:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>rails new rest-rails --api -T<\/code><\/pre>\n\n\n\n<p>Note the &#8211;api parameter.  This Rails application loads a subset of Rails.  You can&#8217;t render views with it, but you can send and receive JSON documents, as we will see.  The following section on authentication was borrowed, with some edits, from a tutorial by GreekDataGuy <strong><a href=\"https:\/\/medium.com\/ruby-daily\/a-devise-jwt-tutorial-for-authenticating-users-in-ruby-on-rails-ca214898318e\">here.<\/a><\/strong><\/p>\n\n\n\n<h2>Initial Setup<\/h2>\n\n\n\n<p>You will need some additional gems.  Add the following to your Gemfile.  These settings should be added before the group development, test section.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>gem 'devise'\ngem 'devise-jwt'\ngem 'rack-cors'<\/code><\/pre>\n\n\n\n<p>Then do a bundle install.  Then edit config\/initializers\/cors.rb to match the following:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>Rails.application.config.middleware.insert_before 0, Rack::Cors do\n  allow do\n    origins '*'\n\n    resource '*',\n             headers: :any,\n             methods: &#91;:get, :post, :put, :patch, :delete, :options, :head]\n  end\nend<\/code><\/pre>\n\n\n\n<p>THis allows your server to accept REST requests from any origin.  This is not a good general practice &#8212; you would want to specify the address of your front end application instead of * &#8212; but CORS is outside the scope of this lesson.<\/p>\n\n\n\n<p>Next we set up devise.  Devise is a gem that enables authentication, and we are using it in combination with devise-jwt, which allows the creation of json web tokens as credentials. Enter the following commands:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>bin\/rails g devise:install\nbin\/rails g devise User\nbin\/rails db:migrate<\/code><\/pre>\n\n\n\n<p>Update the app\/models\/user.rb file as follows:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>class User &lt; ApplicationRecord\n  validates :email, presence: true, uniqueness: true\n\n  devise :database_authenticatable,\n         :jwt_authenticatable,\n         :registerable,\n         jwt_revocation_strategy: JwtDenylist\nend<\/code><\/pre>\n\n\n\n<p>One of the problems with JWT token authentication is logoff.  In order to enable logoff, we have to invalidate the token, and one means of doing that is to create a list of revoked tokens.  Create another model file called&nbsp;app\/models\/jwt_denylist.rb&nbsp;and paste in the following.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>class JwtDenylist &lt; ApplicationRecord\n  include Devise::JWT::RevocationStrategies::Denylist\n\n  self.table_name = 'jwt_denylist'\nend<\/code><\/pre>\n\n\n\n<p>Next, create a migration for the jwt_denylist table:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>rails g migration CreateJwtDenylist<\/code><\/pre>\n\n\n\n<p>The migration file you have created, in db\/migrate, should be edited to match this:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>class CreateJwtDenylist &lt; ActiveRecord::Migration&#91;6.1]\n  def change\n    create_table :jwt_denylist do |t|\n      t.string :jti, null: false\n      t.datetime :exp, null: false\n    end\n    add_index :jwt_denylist, :jti\n  end\nend<\/code><\/pre>\n\n\n\n<p>Then  run the migration.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>bin\/rails db:migrate<\/code><\/pre>\n\n\n\n<p>This completes the initial setup.<\/p>\n\n\n\n<h2>Creating Controllers<\/h2>\n\n\n\n<p>We need three controllers, one for user registration, one for session management, and one for testing logon.  So, enter the following commands:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>bin\/rails g controller users\/Registrations\nbin\/rails g controller users\/Sessions\nbin\/rails g controller test<\/code><\/pre>\n\n\n\n<p>Edit app\/controllers\/users\/registrations_controller.rb, to match the following:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>class Users::RegistrationsController &lt; Devise::RegistrationsController\n  respond_to :json\n\n  private\n\n  def respond_with(resource, _opts = {})\n    register_success &amp;&amp; return if resource.persisted?\n\n    register_failed\n  end\n\n  def register_success\n    render json: { message: 'Signed up sucessfully.' }, status: :created\n  end\n\n  def register_failed\n    render json: { message: \"Something went wrong.\" }, status: :bad_request\n  end\nend<\/code><\/pre>\n\n\n\n<p>It is not really obvious what this controller does, but it overrides the Devise controller to handle JSON responses.  The same is true of app\/controllers\/users\/sessions_controller.rb, which should be changed to match this:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>class Users::SessionsController &lt; Devise::SessionsController\n  respond_to :json\n\n  private\n\n  def respond_with(resource, _opts = {})\n    if !resource.id.nil?\n      response.set_header('Access-Control-Expose-Headers','authorization')\n      render json: { message: 'You are logged in.' }, status: :created\n    else\n      render json: { message: 'Authentication failed.'}, status: :unauthorized\n    end\n  end\n\n  def respond_to_on_destroy\n    log_out_success &amp;&amp; return if current_user\n\n    log_out_failure\n  end\n\n  def log_out_success\n    render json: { message: \"You are logged out.\" }, status: :ok\n  end\n\n  def log_out_failure\n    render json: { message: \"Hmm nothing happened.\"}, status: :unauthorized\n  end\nend<\/code><\/pre>\n\n\n\n<p>In general, REST operations other than registration and logon require authentication.  So we need a method to verify that a user has been authenticated.  We create that method in a new file you should create, app\/controllers\/concerns\/authentication_check.rb, as follows:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>module AuthenticationCheck\n  extend ActiveSupport::Concern\n  \n  def is_user_logged_in\n    if current_user.nil?\n      render json: { message: \"No user is authenticated.\" },\n        status: :unauthorized\n    end\n  end\nend<\/code><\/pre>\n\n\n\n<p>This is the standard way of creating a method that will be accessible to a variety of controllers.  Now edit app\/controllers\/test_controller.rb to match the following.  You will see that it calls the method is_user_logged_in.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>class TestController &lt; ApplicationController\n  include AuthenticationCheck\n\n  before_action :is_user_logged_in\n\n  def show\n    render json: { message: \"If you see this, you're logged in!\" },\n      status: :ok\n  end\nend<\/code><\/pre>\n\n\n\n<p>This is just a test controller to verify that login works.<\/p>\n\n\n\n<h2>The Devise JWT Secret Key<\/h2>\n\n\n\n<p>In JWT based authentication, the tokens are digitally signed.  To make these signatures secure, we need a secret key.  We can&#8217;t put this key in the code, because then it would be stored in github.  Rails has a means of storing secret keys in encrypted form.  We will create the secret and store it in an encrypted credentials file.  The procedure is a little clumsy, because the credentials file can only be edited with a text mode editor, such as, in this case, vi.<\/p>\n\n\n\n<p>Generate the secret with:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>bin\/rake secret<\/code><\/pre>\n\n\n\n<p>This will give a very long string of gobbledygook.  Copy the string to the clipboard.  Then open the credentials file with this command:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>EDITOR=vi rails credentials:edit<\/code><\/pre>\n\n\n\n<p>Here, you may get a message: <\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>Couldn't decrypt config\/credentials.yml.enc. Perhaps you passed the wrong key?<\/code><\/pre>\n\n\n\n<p>If you see this message (this is likely) just delete config\/credentials.yml.enc and repeat the previous command so that you can edit this file.<\/p>\n\n\n\n<p>You next type i to get vi into insert mode.  Then, using the arrow keys, move the cursor to the first line after the end of the file, and type in:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>devise:\n  jwt_secret_key: &lt;rake secret key&gt;<\/code><\/pre>\n\n\n\n<p>Where the rake secret key is pasted in from the clipboard.  This is a yml file, so careful indentation is important.  Then press esc to get out of insert mode and type :wq and press enter.  This will save the encrypted file.  When you get done, run the rails console, and type<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>Rails.application.credentials.devise<\/code><\/pre>\n\n\n\n<p>It should show you the secret, with a key of jwt_secret_key.  If it does not, repeat the steps above.  Do not do the next step until you have the secret key set up correctly.<\/p>\n\n\n\n<p>Edit config\/initializers\/devise.rb to point devise to the encrypted secret we will create.  The following lines should be added to the config block:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>config.jwt do |jwt|\n  jwt.secret = Rails.application.credentials.devise&#91;:jwt_secret_key]\nend<\/code><\/pre>\n\n\n\n<h2>Adding Routes<\/h2>\n\n\n\n<p>Now we need to configure routes for the controllers that have been created.  config\/routes.rb should be edited to match the following:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>Rails.application.routes.draw do\n  devise_for :users,\n             controllers: {\n                 sessions: 'users\/sessions',\n                 registrations: 'users\/registrations'\n             }\n  get '\/test', to: 'test#show'\nend<\/code><\/pre>\n\n\n\n<h2>Testing the REST Server with Curl<\/h2>\n\n\n\n<p>We are now ready to start the REST server.  Typically the server would be called by a separate front end process, written in a framework such as React.  We will create such a front end, just using Rails, in a future lesson.  However, we can test without the front end using a Linux utility called curl, which sends HTTP requests to a specified target.<\/p>\n\n\n\n<p>Start the server with bin\/rails s, or if you are on vagrant, bin\/rails s -b 0.0.0.0.  Then try the following curl commands.  You will need a separate command shell to send the commands.  If you are using vagrant, this will be a separate vagrant ssh session.   Your separate command session should be in a directory that is not part of a git project, as we are going to create some temporary files.<\/p>\n\n\n\n<p>We will first try to access the test controller without being authenticated, using the following command:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>curl -XGET -H \"Content-Type: application\/json\" http:\/\/localhost:3000\/test<\/code><\/pre>\n\n\n\n<p>This will fail.  It will return the 401 unauthorized return code, with a message that no user has been authenticated.  Next, register a user with this command:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>curl -XPOST -H \"Content-Type: application\/json\" -d '{ \"user\": { \"email\": \"test@example.com\", \"password\": \"12345678\" } }' http:\/\/localhost:3000\/users<\/code><\/pre>\n\n\n\n<p>You should see a message come back that the user was signed up successfully.<\/p>\n\n\n\n<p>Now, log in with the following command:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>curl -XPOST -D headers.txt -H \"Content-Type: application\/json\" -d '{ \"user\": { \"email\": \"test@example.com\", \"password\": \"12345678\" } }' http:\/\/localhost:3000\/users\/sign_in<\/code><\/pre>\n\n\n\n<p>You should see a message that you are logged in.  With JWT authentication, the authentication token is returned as a Bearer token in the Authorization header.  The option -D header.txt in the curl command writes the returned headers to the file header.txt.  Display this file using this command:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>cat headers.txt<\/code><\/pre>\n\n\n\n<p>You will see a number of headers, including the authorization header.  We want to include the authorization header in subsequent curl requests, so that they are authenticated.  Use this command to separate out the authorization header:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>grep Authorization headers.txt &gt;authheader.txt<\/code><\/pre>\n\n\n\n<p>Now you can retry access to the test controller as follows:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>curl -XGET -H @authheader.txt -H \"Content-Type: application\/json\" http:\/\/localhost:3000\/test<\/code><\/pre>\n\n\n\n<p>If all is working correctly, you should see a message that tells you you are in.  If this does not work, retrace your steps to see what is wrong.<\/p>\n\n\n\n<p>You can also log out, invalidating the JWT token, with this command:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>curl -XDELETE -H @authheader.txt -H \"Content-Type: application\/json\" http:\/\/localhost:3000\/users\/sign_out<\/code><\/pre>\n\n\n\n<h2>Submitting Your Work<\/h2>\n\n\n\n<p>Once you have this working, do git add, commit, and push of your rest-authentication branch, and then submit your pull request as usual.  In the next section, we will add additional REST operations.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>We are going to create an API that communicates using REST protocols, and that exchanges JSON data. It&#8217;s a good idea to understand what REST is: https:\/\/dzone.com\/articles\/introduction-to-rest-api-restful-web-services And also, you will want to understand JSON: Creating the API Server Application A starter Rails application for the API Server has been created for you in the<\/p>\n","protected":false},"author":5,"featured_media":0,"parent":0,"menu_order":0,"comment_status":"closed","ping_status":"closed","template":"","meta":{"_genesis_hide_title":false,"_genesis_hide_breadcrumbs":false,"_genesis_hide_singular_image":false,"_genesis_hide_footer_widgets":false,"_genesis_custom_body_class":"","_genesis_custom_post_class":"","_genesis_layout":"","_vp_format_video_url":"","_vp_image_focal_point":[]},"featured_image_src":null,"featured_image_src_square":null,"_links":{"self":[{"href":"https:\/\/learn.codethedream.org\/wp-json\/wp\/v2\/pages\/1269"}],"collection":[{"href":"https:\/\/learn.codethedream.org\/wp-json\/wp\/v2\/pages"}],"about":[{"href":"https:\/\/learn.codethedream.org\/wp-json\/wp\/v2\/types\/page"}],"author":[{"embeddable":true,"href":"https:\/\/learn.codethedream.org\/wp-json\/wp\/v2\/users\/5"}],"replies":[{"embeddable":true,"href":"https:\/\/learn.codethedream.org\/wp-json\/wp\/v2\/comments?post=1269"}],"version-history":[{"count":0,"href":"https:\/\/learn.codethedream.org\/wp-json\/wp\/v2\/pages\/1269\/revisions"}],"wp:attachment":[{"href":"https:\/\/learn.codethedream.org\/wp-json\/wp\/v2\/media?parent=1269"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}